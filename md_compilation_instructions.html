<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPEC: SPEC compilation instructions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript">
window.MathJax = {
  options: {
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  },
  tex: {
    macros: {},
    packages: ['base','configmacros','amsmath','amssymb']
  }
};
window.MathJax = {
  loader: {
    load: ['[tex]/color', '[tex]/cancel']
  },
  tex: {
      tags: 'ams',
      packages: {'[+]': ['noerrors'],
                 '[+]': ['color'],
                 '[+]': ['verb'],
                 '[+]': ['cancel']
      },
      macros: { bm: ['{\\boldsymbol #1}',1]
      }
  }
};
// https://docs.mathjax.org/en/latest/web/configuration.html#configuring-and-loading-in-one-script
//(function () {
//  var script = document.createElement('script');
//  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
//  script.async = true;
//  document.head.appendChild(script);
//})();
</script>
<script type="text/javascript" id="MathJax-script" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="SPEC_97x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SPEC<span id="projectnumber">&#160;3.20</span>
   </div>
   <div id="projectbrief">Stepped Pressure Equilibrium Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_compilation_instructions.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SPEC compilation instructions </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The default installation method for SPEC uses CMake and installs the python wrappers and an xspec executable.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Installation using Anaconda</h1>
<p >We recommend you use Anaconda to create a coherent build environment and prevent dependency conflicts.</p>
<p >Control over the installation can be had by editing <code>cmake_config.json</code>, to guide CMake to the right compilers etc. Configurations for different machines are stored in <code>${SPEC_ROOT}/cmake_machines</code>, to use these, link them to cmake_config.json: <code>ln -s cmake_config cmake_machines/&lt;config_file.json&gt;</code></p>
<p >&gt;[!TIP] &gt;install as much as possible in your environment using the <code>conda</code> command, &gt;only use 'pip' at the very end for the last packages. &gt;if you have not added the <code>conda-forge</code> channel do so by &gt;<code>conda config --add channels conda-forge</code></p>
<p >Get the repository and install the necessary compilers and libraries </p><div class="fragment"><div class="line">git clone git@github.com:PrincetonUniversity/SPEC.git </div>
<div class="line">conda create -n &quot;spec_wrapper&quot; python=3.11 # create your environment for SPEC</div>
<div class="line">conda activate spec_wrapper</div>
<div class="line">conda install gcc_linux-64 gxx_linux-64 gfortran_linux-64 # or macOS versions, see note below</div>
<div class="line">conda install hdf5 openblas libopenblas fftw scalapack openmpi cmake ninja</div>
<div class="line">conda install h5py matplotlib f90nml scipy scikit-build mpi4py ipython</div>
<div class="line">pip install f90wrap</div>
</div><!-- fragment --><p >&gt;[!NOTE] </p><blockquote class="doxtable">
<p >for macOS users use the respective compiler packages; <code>conda install clang_osx-64 clangxx_osx-64 gfortran_osx-64</code> </p>
</blockquote>
<p >Finally, install SPEC and the wrapper (logs will be in <code>compile.log</code>) </p><div class="fragment"><div class="line">pip install -v . 2&gt;&amp;1 | tee compile.log</div>
</div><!-- fragment --><p >Install the <code>py_spec</code> python library </p><div class="fragment"><div class="line">cd Utilities/pythontools/</div>
<div class="line">pip install -e .</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2"></a>
Troubleshooting Anaconda install</h2>
<p >If using a newer version of python, <code>f2py3</code> is no longer shipped. If your system contains an old python install (for example from your OS), CMake can find its <code>f2py3</code> and give try to use it to compile the wrappers instead of your environments <code>f2py</code>. Test this by looking if you have an <code>f2py3</code> in your path: <code>$which f2py3</code>. The easiest workaround is to create a link called f2py3 that links to f2py so it is found first. </p><div class="fragment"><div class="line">ln -s ~/anaconda3/envs/spec_wrapper/bin/f2py ~/anaconda3/envs/spec_wrapper/bin/f2py3</div>
</div><!-- fragment --><p >You might have HDF5 or FFTW environment variables set (for example for a VMEC install). This can throw off CMake, which we want to use only anaconda. </p><div class="fragment"><div class="line">unset HDF5, HDF5_ROOT, HDF5_HOME, FFTW, FFTW_DIR</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3"></a>
Testing your SPEC installation</h2>
<p >First, verify that the stand-alone executable is usable. A few test cases are provided in <code>InputFiles/TestCases</code>.</p>
<p >Create a new directory for SPEC runs and change into it</p>
<div class="fragment"><div class="line">mkdir ~/SPEC_runs</div>
<div class="line">cd ~/SPEC_runs</div>
</div><!-- fragment --><p >Copy a demo input file into the current working directory:</p>
<div class="fragment"><div class="line">cp ~/SPEC/InputFiles/TestCases/G3V01L0Fi.001.sp .</div>
</div><!-- fragment --><p >Call SPEC with an input file (<code>*.sp</code>) as argument on the command line:</p>
<div class="fragment"><div class="line">xspec G3V01L0Fi.001.sp</div>
</div><!-- fragment --><p >You should see the screen output of the SPEC run. Among the last lines should be something similar to this:</p>
<div class="fragment"><div class="line">ending :       0.88 : myid=  0 ; completion ; time=      0.88s =     0.01m =   0.00h =  0.00d ; date= 2022/02/17 ; time= 17:35:33 ; ext = G1V02L0Fi.001                                               </div>
<div class="line">ending :            : </div>
<div class="line">xspech :            :</div>
<div class="line">xspech :       0.88 : myid=  0 : time=    0.01m =   0.00h =  0.00d ;</div>
</div><!-- fragment --><p >This indicates that the stand-alone executable is usable.</p>
<p >Next, the python wrapper is tested.</p>
<ol type="1">
<li><p class="startli">Check that the SPEC version can be found:</p>
<div class="fragment"><div class="line">python -c &quot;from spec import spec_f90wrapped as spec; print(&#39;SPEC version: {:}&#39;.format(spec.constants.version))&quot;</div>
</div><!-- fragment --><p class="startli">This should print a message like "SPEC version: 3.1" on the screen.</p>
</li>
<li><p class="startli">Check that the Python wrapper can be used as a stand-alone code:</p>
<div class="fragment"><div class="line">OMP_NUM_THREADS=1 python ~/SPEC/Utilities/python_wrapper/spec/core.py G3V01L0Fi.001.sp</div>
</div><!-- fragment --><p class="startli">This should conclude with the message <code>SPEC called from python finished!</code>.</p>
</li>
<li><p class="startli">Run the optimization example code:</p>
<div class="fragment"><div class="line">OMP_NUM_THREADS=1 python ~/SPEC/Utilities/python_wrapper/examples/example.py</div>
</div><!-- fragment --><p class="startli">This should run a basic optimization problem, where the SPEC inputs are controlled via <code>scipy.optimize</code>.</p>
</li>
<li><p class="startli">Run the interactive re-convergence example code:</p>
<div class="fragment"><div class="line">OMP_NUM_THREADS=1 python ~/SPEC/Utilities/python_wrapper/examples/example_2.py</div>
</div><!-- fragment --><p class="startli">This should compute a SPEC equilibrium, then change the central pressure, re-converge SPEC, etc. for a set of five values of the central pressure in a two-volume classical Stellarator case. After the pressure scan with re-convergence, a plot of the MHD energy vs. the central pressure is shown.</p>
</li>
</ol>
<h1><a class="anchor" id="autotoc_md4"></a>
Other legacy installations</h1>
<p >It is still possible to compile SPEC using <code>make</code> or <code>cmake</code> directly, and bypass the wrapper installation.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
CMake installation</h2>
<p >Spec can be installed using CMake to find the relevant libraries to link against. You can control in the root directory of SPEC do the following: </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
</div><!-- fragment --><p> This will compile SPEC (not the wrappers). The <code>xspec</code> executable is found in ${SPEC_ROOT}/build/build/bin/xspec</p>
<h2><a class="anchor" id="autotoc_md6"></a>
Make installation</h2>
<p >SPEC can also be installed using the <code>make</code> command in the root directory.</p>
<p >The <code>make</code> install is controlled by the <code>BUILD_ENV</code> environment variable. Available options are found in the <code>SPECfile</code> where different link and compile flags for many machines are found.</p>
<p >If you cannot find your machine in the list, copy a similar machine and adapt as needed. Then compile by running the command</p>
<div class="fragment"><div class="line">BUILD_ENV=&lt;machine_name&gt; make</div>
</div><!-- fragment --><p >The <code>make</code> process creates files in the SPEC_ROOT directory, and creates the <code>xspec</code> executable there.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Build process</h1>
<p >the source files are found in the <code>${SPEC_ROOT}/src/ directory</code>. The <code>.f90</code> files contain macros that are expanded during the make process using the <code>m4</code> command.</p>
<p >Depending on the build type, the macro-expanded code is either found in <code>build/src/</code>, in the root directory, or in the <code>_skbuild</code> folder.</p>
<p >&gt;[!TIP] &gt;The line numbers in error messages correspond to the macro-expanded code</p>
<p >The macros are defined in <code>src/macros</code> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
