<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SPEC: Compilation hints for SPEC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
<script>
window.MathJax = {
  loader: {
    load: ['[tex]/color', '[tex]/cancel']
  },
  tex: {
      tags: 'ams',
      packages: {'[+]': ['noerrors'],
                 '[+]': ['color'],
                 '[+]': ['verb'],
                 '[+]': ['cancel']
      }
      macros: { bm: ['{\\boldsymbol #1}',1]
      }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.0.0/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="SPEC_97x55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SPEC
   &#160;<span id="projectnumber">3.10</span>
   </div>
   <div id="projectbrief">Stepped Pressure Equilibrium Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_Compile.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Compilation hints for SPEC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In order to run SPEC, you need a copy of the HDF5 libraries installed which has both the Fortran interface and the parallel (MPI I/O) enabled.</p>
<h1><a class="anchor" id="autotoc_md2"></a>
Installation with CMake</h1>
<p>Using cmake, SPEC can be built as a stand-alone executable or as a python extension, where SPEC can be run directly from python, with all variables passed directly in memory.</p>
<p>Download the package from git. And change to the root directory of SPEC source code by running </p><div class="fragment"><div class="line">cd &lt;SPEC_ROOT&gt;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3"></a>
Stand-alone Executable Compiling</h2>
<p>Compiling SPEC requires MPI, HDF5, and numerical libraries such as BLAS, LAPACK, FFTW. For numerical libraries, you could use system supplied libraries or you could use intel math kernel library (MKL).</p>
<h3><a class="anchor" id="autotoc_md4"></a>
CentOS</h3>
<p>Here instructions are given for CentOS 7</p>
<h4><a class="anchor" id="autotoc_md5"></a>
Dependencies</h4>
<p>Install OpenBLAS, FFTW3, and hdf5 using the command </p><div class="fragment"><div class="line">yum install -y  gcc-gfortran openmpi openmpi-devel hdf5 hdf5-devel fftw3 fftw3-devel openblas openblas-devel python3 python3-devel cmake ninja-build</div>
</div><!-- fragment --><p> If you don't have the latest version of cmake avaialable on your system, you can create a python virtual environment (<a href="https://packaging.python.org/guides/installing-using-pip-and-virtual-environments/">instructions are here</a>), activate it, and then install cmake in that virtual environment using pip </p><div class="fragment"><div class="line">pip install cmake ninja</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md6"></a>
Configure</h4>
<p>When using cmake to build SPEC, the first step is to configure compilers and the locations of libraries. Cmake can detect compilers and libraries at standard locations easily but needs hand-holding when the required libraries are non-standard locations.</p>
<p>The following command was used to configure cmake build setup for SPEC on Centos </p><div class="fragment"><div class="line">cmake -S. -Bbuild -GNinja -DCMAKE_Fortran_COMPILER=mpifort -DBLA_VENDOR=OpenBLAS -DHDF5_NO_FIND_PACKAGE_CONFIG_FILE=TRUE -DHDF5_PREFER_PARALLEL=TRUE -DCMAKE_INSTALL_PREFIX=${SPEC_ROOT}/install --trace-source=CMakeLists.txt 2&gt;&amp;1 | tee log</div>
</div><!-- fragment --><p> There are few points to note on the above command</p><ul>
<li>All the build related files will be in build folder.</li>
<li>Ninja build system is used. If your system doesn't have ninja installed, remove the -G option. The default is the standard <code>make</code> tool.</li>
<li>We ae using OpenBLAS for BLAS and LAPACK and MPI fortran compiler</li>
<li>Since most of the libraries are in standard location, we don't have to specify them. We are giving couple of options related to HDF5 libraries.</li>
<li>The installation path is install subfolder location within SPEC folder.</li>
<li>We are interested in a verbose output and also want to store the output in <code>log</code> file.</li>
</ul>
<h4><a class="anchor" id="autotoc_md7"></a>
Build</h4>
<p>After successful completion of cmake configuration step, building is trivial </p><div class="fragment"><div class="line">cmake --build build</div>
<div class="line">````</div>
<div class="line">#### Install</div>
<div class="line">The last step is to install the executable by running</div>
<div class="line">```bash</div>
<div class="line">cmake --install build</div>
</div><!-- fragment --><p>That's it! If all the above steps completed without errors, you have the SPEC executable <code>xspec</code> installed at <code>install/bin</code> folder</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Python Extension Compiling</h2>
<p>Building the SPEC python extension will also build the SPEC executable. In the SPEC root folder, edit the <code>cmake_config.json</code> as necessary for your system. Few example <code>.json</code> files are provided in the <code>cmake_machines</code> folder.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Dependencies</h3>
<p>It is strongly suggested to use a python virtual environment either conda or python venv. After virtual environment is installed and activated, install the python related dependencies. Please note that these are in addition to the dependencies listed earlier in stand-alone installation steps. If you are using conda virtual environment try installing the dependencies using <code>conda install</code> command </p><div class="fragment"><div class="line">conda  install -n &lt;your_venv&gt; numpy f90nml scikit-build cmake ninja</div>
</div><!-- fragment --><p>If you are using venv virtual environment, run </p><div class="fragment"><div class="line">pip install numpy f90nml scikit-build cmake ninja</div>
</div><!-- fragment --><p> Now install f90wrap. Please keep in mind that numpy has to be installed before installing f90wrap. </p><div class="fragment"><div class="line">pip install -U git+https://github.com/zhucaoxiang/f90wrap</div>
</div><!-- fragment --><p>Now install the SPEC extension by running the setup.py script present in the SPEC root folder. </p><div class="fragment"><div class="line">python setup.py bdist_wheel; cd dist/;  pip install *.whl</div>
</div><!-- fragment --><p> in succession. At this point, you should be able to import the <code>spec</code> module in python. To test this, you can try the following command from the shell: </p><div class="fragment"><div class="line">python -c &quot;import spec; print(&#39;success&#39;)&quot;</div>
</div><!-- fragment --><p>If you want editable install, run </p><div class="fragment"><div class="line">python setup.py develop </div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
Stellar cluster at PPPL</h2>
<h3><a class="anchor" id="autotoc_md11"></a>
Python wrapper</h3>
<p>Below are the steps to build python wrappers for SPEC on stellar.</p>
<ol type="1">
<li><p class="startli">Needed modules are </p><blockquote class="doxtable">
<p>i. hdf5/gcc/1.10.6 ii. intel-mkl/2021.1.1 iii. openmpi/gcc/4.1.0 iv. anaconda3/2021.5. </p>
</blockquote>
<p>&mdash; <b>Note</b></p>
<p class="startli">FFTW is supplied as part of Intel MKL and we just need to link against MKL.</p>
</li>
</ol>
<hr  />
<p> Load the modules by running </p><div class="fragment"><div class="line">module load hdf5/gcc/1.10.6 intel-mkl/2021.1.1 openmpi/gcc/4.1.0 anaconda3/2021.5</div>
</div><!-- fragment --><ol type="1">
<li>Create conda virtual environment. <div class="fragment"><div class="line">conda create -n spec_ve python=3.8</div>
</div><!-- fragment --> You have to press enter twice. Here a conda virtual environment named <code>spec_ve</code> is created with python version 3.8 and lot of packages are installed. Activate by running <div class="fragment"><div class="line">conda activate spec_ve</div>
</div><!-- fragment --></li>
<li>Install <code>cmake</code>, <code>ninja</code>, <code>scikit-build</code>, <code>numpy</code> using either conda or pip. <div class="fragment"><div class="line">conda install cmake ninja scikit-build numpy</div>
</div><!-- fragment --> or <div class="fragment"><div class="line">pip install cmake ninja scikit-build numpy</div>
</div><!-- fragment --></li>
<li>Install <code>f90wrap</code> by running <div class="fragment"><div class="line">pip install git+https://github.com/zhucaoxiang/f90wrap.git</div>
</div><!-- fragment --></li>
<li>Clone the spec repo from github <div class="fragment"><div class="line">git clone https://github.com/PrincetonUniversity/SPEC.git</div>
</div><!-- fragment --> Change the working directory by running <code>cd SPEC</code>.</li>
<li>Edit the cmake_config.json to populate correct cmake_flags. For stellar, cmake_config.json should look like <div class="fragment"><div class="line">{</div>
<div class="line">  &quot;cmake_args&quot;: [</div>
<div class="line">    &quot;-DCMAKE_C_COMPILER=mpicc&quot;,</div>
<div class="line">    &quot;-DCMAKE_CXX_COMPILER=mpicxx&quot;,</div>
<div class="line">    &quot;-DCMAKE_Fortran_COMPILER=mpifort&quot;,</div>
<div class="line">    &quot;-DBLA_VENDOR=Intel10_64lp&quot;,</div>
<div class="line">    &quot;-DHDF5_ROOT=/usr/local/hdf5/gcc/1.10.6&quot;,</div>
<div class="line">    &quot;-DHDF5_PREFER_PARALLEL=False&quot;]</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Then build the python wheel for SPEC wrapper using <div class="fragment"><div class="line">python setup.py bdist_wheel</div>
</div><!-- fragment --> The resulting wheel is located in <code>dist</code> folder. Install SPEC python wrapper by running <div class="fragment"><div class="line">pip install dist/spec*.whl</div>
</div><!-- fragment --></li>
<li>Install mpi4py using pip/conda. If using pip, don't forget to use <code>--no-cache-dir</code> flag <div class="fragment"><div class="line">pip install --no-cache-dir mpi4py</div>
</div><!-- fragment --> or <div class="fragment"><div class="line">conda install mpi4py</div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="autotoc_md13"></a>
SPEC executable.</h3>
<p>The python wrapper builds spec executable but it gets installed at an obscure location. If you mainly want SPEC executable <code>xspec</code>, the steps are similar.</p><ol type="1">
<li>Load the required modules. Refer to the first step in the python wrapper instructions.</li>
<li>Clone the SPEC repo and make SPEC as working directory. Refer to the 5th step above.</li>
<li>Run the cmake configuration by running <div class="fragment"><div class="line">cmake -Bbuild -S . -DCMAKE_C_COMPILER=mpicc -DCMAKE_CXX_COMPILER=mpicxx -DCMAKE_Fortran_COMPILER=mpifort -DBLA_VENDOR=Intel10_64lp \</div>
<div class="line">-DHDF5_ROOT=/usr/local/hdf5/gcc/1.10.6 -DHDF5_PREFER_PARALLEL=False -DCMAKE_INSTALL_PREFIX=&lt;SPEC_install_location&gt;</div>
</div><!-- fragment --> Please note SPEC gets installed at <code>&lt;SPEC_install_location&gt;/bin</code>, where <code>&lt;SPEC_install_location&gt;</code> is the folder of your choice. Building of SPEC library will be done in the folder <code>build</code>, where all the intermediary compilation files will be located.</li>
<li>Compile the code by running <div class="fragment"><div class="line">cmake --build build</div>
</div><!-- fragment --> This command will invoke <code>make</code> build generator. Alternatively, you can switch to build folder and run make utility manually. <div class="fragment"><div class="line">cd build</div>
<div class="line">make</div>
</div><!-- fragment --></li>
<li>Install the SPEC executable by running <div class="fragment"><div class="line">cmake --install build</div>
</div><!-- fragment --> SPEC library gets installed <code>&lt;SPEC_install_location&gt;/lib</code> and SPEC executable get installed at <code>&lt;SPEC_install_location&gt;/bin</code></li>
</ol>
<h2><a class="anchor" id="autotoc_md14"></a>
Mac</h2>
<p>Here is how to build the HDF5 library :</p><ol type="1">
<li>download <code>hdf5-1.10.5.tar.gz</code> from <a href="https://www.hdfgroup.org/downloads/hdf5/source-code/">https://www.hdfgroup.org/downloads/hdf5/source-code/</a></li>
<li>extract: <code>tar xzf hdf5-1.10.5.tar.gz</code></li>
<li>cd into source folder: <code>cd hdf5-1.10.5</code></li>
<li>make a build folder: <code>mkdir build</code></li>
<li>cd into build folder: <code>cd build</code></li>
<li>run cmake with options for the Fortran interface: <code>cmake -DHDF5_BUILD_FORTRAN:BOOL=ON ..</code></li>
<li>actually build the HDF5 library: <code>make</code></li>
</ol>
<p>This should leave you with a file "hdf5-1.10.5.dmg" or similar, which you can install just as any other Mac application. See e.g. this document for more detailed instructions: <a href="https://support.hdfgroup.org/ftp/HDF5/current/src/unpacked/release_docs/INSTALL_CMake.txt">https://support.hdfgroup.org/ftp/HDF5/current/src/unpacked/release_docs/INSTALL_CMake.txt</a></p>
<p>The compilation of SPEC itself then proceeds as usual. You then only need to specify the HDF5 folder in the Makefile, which will likely be <code>/Applications/HDF_Group/HDF5/1.10.5</code>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
